<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abdul Mannan AI — Full Feature</title>
<meta name="color-scheme" content="light dark">

<style>
:root{
  --bg:#0b1020; --card:#0f1724; --muted:#9aa4b2; --accent:#06b6d4; --accent-2:#06b6a4;
  --user:#2563eb; --bot:#fbbf24; --glass:rgba(255,255,255,0.03); --radius:14px; --transition:.3s;
}
[data-theme="light"]{
  --bg:#f7fafc; --card:#ffffff; --muted:#6b7280; --accent:#0891b2; --accent-2:#06a3a0;
  --user:#0ea5e9; --bot:#f59e0b; --glass:rgba(2,6,23,0.03);
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--muted);transition:all var(--transition);}
.app{max-width:1100px;margin:28px auto;padding:20px;display:grid;grid-template-columns:360px 1fr;gap:20px;}
.panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);}
.left .title{font-weight:700;color:var(--accent);font-size:18px;margin-bottom:6px;}
.left .desc{font-size:13px;color:var(--muted);margin-bottom:12px;}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600;transition:.3s;}
.btn:hover{opacity:.85;}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#001018;border:none;}
.btn.small{padding:6px 8px;font-size:13px;}
.chat{display:flex;flex-direction:column;height:76vh;}
.messages{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));}
.msg{max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.45;word-wrap:break-word;color:#041017;}
.msg.user{background:linear-gradient(90deg,var(--user),#1d4ed8);color:white;margin-left:auto;border-bottom-right-radius:6px;}
.msg.bot{background:linear-gradient(90deg,var(--bot),#f59e0b);color:#041017;border-bottom-left-radius:6px;}
.input-area{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);}
.text-input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);font-size:15px;background:transparent;color:var(--muted);min-height:44px;resize:none;}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto;padding-right:6px;}
.history-item{padding:10px;border-radius:8px;background:var(--glass);cursor:pointer;display:flex;gap:10px;align-items:center;transition:.3s;}
.history-item:hover{background:rgba(255,255,255,0.06);}
.file-input{display:none;}
.footer{margin-top:10px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;}
.badge{padding:4px 8px;border-radius:999px;font-size:12px;background:rgba(255,255,255,0.03);}
@media(max-width:980px){.app{grid-template-columns:1fr;padding:12px}.left{order:2}.chat{order:1;height:68vh}}
</style>
</head>

<body>
<div class="app" id="app">

  <!-- LEFT PANEL -->
  <div class="panel left">
    <div class="title">Abdul Mannan AI</div>
    <div class="desc small">Backend: <span id="backendUrl" class="badge"></span></div>

    <div class="controls">
      <button class="btn primary small" id="newConv">New</button>
      <button class="btn small" id="exportBtn">Export</button>
      <button class="btn small" id="importBtn">Import</button>
      <input type="file" id="importFile" class="file-input" accept=".json">
    </div>

    <div class="small" style="margin-bottom:8px">Conversations</div>
    <div class="history-list" id="historyList"></div>

    <div class="footer">
      <div class="small">Model: <strong id="modelLabel"></strong></div>
      <div class="small" id="statusBadge">Ready</div>
    </div>
  </div>

  <!-- CHAT WINDOW -->
  <div class="panel chat">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <textarea id="input" class="text-input" rows="1" placeholder="Ask anything..."></textarea>
      <button class="btn primary small" id="sendBtn">Send</button>
    </div>
  </div>

</div>

<script>
// =======================================
// CONFIG
// =======================================

const API_URL = "https://abdul-mannan.abdulmmm556.workers.dev";

// ⭐ Recommended Cloudflare Model
const MODEL = "@cf/meta/llama-3.1-8b-instruct";

document.getElementById("backendUrl").textContent = API_URL;
document.getElementById("modelLabel").textContent = MODEL;

// =======================================
// STATE
// =======================================

const LOCALSTORAGE_KEY = "amn_full_chat_v3";
const state = { conversations: [], activeId: null };

// =======================================
// HELPERS
// =======================================

function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;")
          .replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

function markdownToHtml(md){
  if(!md) return "";
  md = md.replace(/```([\s\S]*?)```/g,(m,c)=>`<pre><code>${escapeHtml(c)}</code></pre>`);
  md = md.replace(/`([^`]+)`/g,(m,c)=>`<code>${escapeHtml(c)}</code>`);
  md = md.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");
  return md.split("\n").map(l=>l?`<p>${l}</p>`:"").join("");
}

// =======================================
// LOCAL STORAGE
// =======================================

function saveState(){
  localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  try{
    const raw = localStorage.getItem(LOCALSTORAGE_KEY);
    if(raw) Object.assign(state, JSON.parse(raw));
  }catch{}
}

// =======================================
// CONVERSATIONS UI
// =======================================

const messagesEl = document.getElementById("messages");
const historyListEl = document.getElementById("historyList");

function currentConv(){
  return state.conversations.find(c => c.id === state.activeId);
}

function newConversation(){
  const id = "c_" + Date.now();
  state.conversations.unshift({ id, title: "New Chat", messages: [] });
  state.activeId = id;
  saveState();
  renderHistory();
  renderMessages();
}

function renderHistory(){
  historyListEl.innerHTML = "";
  for(const conv of state.conversations){
    const item = document.createElement("div");
    item.className = "history-item";
    item.innerHTML = `
      <div style="flex:1">
        <div>${escapeHtml(conv.title)}</div>
        <div class="small">${conv.messages.length} messages</div>
      </div>`;
    item.onclick = () => {
      state.activeId = conv.id;
      renderMessages();
      renderHistory();
    };
    historyListEl.appendChild(item);
  }
}

function renderMessages(){
  messagesEl.innerHTML = "";
  const conv = currentConv();
  if(!conv) return;
  for(const msg of conv.messages){
    const div = document.createElement("div");
    div.className = "msg " + (msg.role === "user" ? "user" : "bot");
    div.innerHTML = markdownToHtml(msg.content);
    messagesEl.appendChild(div);
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// =======================================
// SEND MESSAGE
// =======================================

async function sendMessage(){
  const inputEl = document.getElementById("input");
  const text = inputEl.value.trim();
  if(!text) return;

  const conv = currentConv();
  const userMsg = { role: "user", content: text };
  conv.messages.push(userMsg);

  inputEl.value = "";
  renderMessages();
  saveState();

  await fetchBot(conv, text);
}

async function fetchBot(conv, prompt){
  const statusEl = document.getElementById("statusBadge");
  statusEl.textContent = "Typing...";

  try{
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ model: MODEL, prompt })
    });

    const botMsg = { role: "bot", content: "" };
    conv.messages.push(botMsg);
    renderMessages();

    // Streaming reader
    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    while(true){
      const { value, done } = await reader.read();
      if(done) break;
      botMsg.content += decoder.decode(value);
      renderMessages();
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  }catch{
    alert("Error: Could not contact backend");
  }finally{
    statusEl.textContent = "Ready";
    saveState();
  }
}

// =======================================
// EVENT LISTENERS
// =======================================

document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("input").addEventListener("keydown", e=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

document.getElementById("newConv").onclick = newConversation;

// Export conversations
document.getElementById("exportBtn").onclick = () =>{
  const blob = new Blob([JSON.stringify(state.conversations,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chats.json";
  a.click();
};

// Import conversations
document.getElementById("importBtn").onclick = () => {
  document.getElementById("importFile").click();
};

document.getElementById("importFile").onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      state.conversations = JSON.parse(reader.result);
      state.activeId = state.conversations[0]?.id || null;
      renderHistory();
      renderMessages();
      saveState();
    }catch{
      alert("Invalid file");
    }
  };
  reader.readAsText(file);
};

// =======================================
// INIT
// =======================================

loadState();
if(!state.activeId) newConversation();
renderHistory();
renderMessages();

</script>
</body>
</html>
